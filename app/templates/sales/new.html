{% extends "base.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
  <div>
    <h3 class="mb-0">Ventas</h3>
    <div class="text-muted small">Busca productos y registra en segundos</div>
  </div>

  <!--div class="d-flex gap-2">
    <a class="btn btn-outline-primary btn-sm" href="{{ url_for('products.list_products') }}">Productos</a>
    <a class="btn btn-outline-success btn-sm" href="{{ url_for('reports.reports_home') }}">Reportes</a>
  </div-->
</div>

<div class="row g-3">
  <!-- Form / POS -->
  <div class="col-12 col-lg-7">
    <div class="card shadow-sm">
      <div class="card-body">
		{% if quick_products %}
		  <div class="mb-3">
			<div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
			  <h6 class="mb-0">Venta rápida</h6>
			  <span class="text-muted small">Toque = +1 al carrito</span>
			</div>

			<div class="row g-2 mt-1">
			  {% for p in quick_products %}
			  <div class="col-6 col-md-4">
				<form method="post" action="{{ url_for('sales.cart_add_quick', product_id=p.id) }}">
				  <button class="btn btn-outline-dark w-100 text-start">
					<div class="fw-semibold small text-truncate">{{ p.name }}</div>
					<div class="d-flex justify-content-between small text-muted">
					  <span>${{ "%.2f"|format(p.price) }}</span>
					  <span>St: {{ p.stock }}</span>
					</div>
				  </button>
				</form>
			  </div>
			  {% endfor %}
			</div>
		  </div>
		{% endif %}

		
        <h5 class="mb-3">Agregar al carrito</h5>

        <form method="post" action="{{ url_for('sales.cart_add') }}" class="row g-2 align-items-end">
          <div class="col-12">
            <label class="form-label mb-1">Producto</label>

            <input id="productSearch"
                   class="form-control"
                   list="productsList"
                   placeholder="Escribe para buscar..."
                   autocomplete="off"
                   required>

            <datalist id="productsList">
              {% for p in products %}
                <option value="{{ p.name }}"
                        data-id="{{ p.id }}"
                        data-price="{{ p.price }}"
                        data-stock="{{ p.stock }}"></option>
              {% endfor %}
            </datalist>

            <input type="hidden" name="product_id" id="productId">

            <div class="text-muted small mt-1" id="productMeta">
              Selecciona un producto para ver precio y stock.
            </div>
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label mb-1">Cantidad</label>
            <input class="form-control" type="number" min="1" name="quantity" id="qty" value="1" required>
          </div>

          <div class="col-12 col-md-8 d-grid">
            <button class="btn btn-dark" id="btnAdd">Agregar</button>
          </div>
        </form>

        <div class="alert alert-light border mt-3 mb-0 small text-muted">
          Tip: Escribe el nombre, selecciona el producto, ajusta cantidad y presiona <strong>Agregar</strong>.
        </div>

      </div>
    </div>
  </div>

  <!-- Carrito -->
  <div class="col-12 col-lg-5">
    <div class="card shadow-sm">
      <div class="card-body d-flex justify-content-between align-items-center flex-wrap gap-2">
        <h5 class="mb-0">Carrito</h5>

        <form method="post" action="{{ url_for('sales.cart_clear') }}">
          <button class="btn btn-outline-danger btn-sm" {% if not cart %}disabled{% endif %}>
            Vaciar
          </button>
        </form>
      </div>

      <div class="table-responsive">
        <table class="table mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th>Producto</th>
              <th class="text-end">Cant.</th>
              <th class="text-end">Total</th>
              <th style="width:90px;"></th>
            </tr>
          </thead>
          <tbody>
            {% for i in cart %}
            <tr>
              <td class="small">{{ i.product_name }}</td>
              <td class="text-end">{{ i.quantity }}</td>
              <td class="text-end text-success">${{ "%.2f"|format(i.total|float) }}</td>
              <td class="text-end">
                <form method="post" action="{{ url_for('sales.cart_remove', idx=loop.index0) }}">
                  <button class="btn btn-outline-secondary btn-sm">Quitar</button>
                </form>
              </td>
            </tr>
            {% endfor %}

            {% if not cart %}
            <tr>
              <td colspan="4" class="text-center text-muted py-3">Carrito vacío</td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>

      <div class="card-body d-flex justify-content-between align-items-center">
        <div class="fw-bold">TOTAL</div>
        <div class="fs-4 text-success">${{ "%.2f"|format(cart_total) }}</div>
      </div>

      {# En el siguiente paso pondremos aquí el botón FINALIZAR VENTA #}
      {
      <div class="card-body pt-0">
        <form method="post" action="{{ url_for('sales.checkout') }}">
          <button class="btn btn-success w-100" {% if not cart %}disabled{% endif %}>
            Finalizar venta
          </button>
        </form>
      </div>
      }

    </div>
  </div>
</div>

<!-- Última venta + Historial -->
<div class="row g-3 mt-1">
  <div class="col-12 col-lg-5">
	{% if last_sale %}
	<div class="card shadow-sm border-success">
	  <div class="card-body">
		<div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
		  <h6 class="mb-0">Última venta</h6>
		  <span class="badge bg-success">Ticket #{{ last_sale.id }} ✅</span>
		</div>

		<div class="mt-2 small text-muted">
		  Ítems: <strong>{{ last_sale.items|length }}</strong><br>
		  Total: <strong class="text-success">${{ "%.2f"|format(last_sale.total) }}</strong>
		  {% if last_sale.items and last_sale.items[0] %}
			<br>Primer producto: <strong>{{ last_sale.items[0].product_name }}</strong>
		  {% endif %}
		</div>
	  </div>
	</div>
	{% endif %}

  </div>

  <div class="col-12 col-lg-7">
    <div class="card shadow-sm">
      <div class="card-body">
        <h6 class="mb-2">Historial reciente</h6>
        <div class="table-responsive">
          <table class="table mb-0 align-middle">
            <thead class="table-light">
              <tr>
				<th>Fecha</th>
				<th>Venta</th>
				<th class="text-end">Ítems</th>
				<th class="text-end">Total</th>
              </tr>
            </thead>
            <tbody>
              {% for s in recent_sales %}
				<tr class="{% if last_sale and s.id == last_sale.id %}table-success{% endif %}">
				  <td class="text-muted small">{{ s.created_at }}</td>
				  <td>Ticket #{{ s.id }}</td>
				  <td class="text-end">{{ s.items|length }}</td>
				  <td class="text-end text-success">${{ "%.2f"|format(s.total) }}</td>
				</tr>
			{% endfor %}

              {% if not recent_sales %}
              <tr>
                <td colspan="4" class="text-center text-muted py-3">Aún no hay ventas</td>
              </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const search = document.getElementById("productSearch");
  const hiddenId = document.getElementById("productId");
  const meta = document.getElementById("productMeta");
  const btnAdd = document.getElementById("btnAdd");
  const qty = document.getElementById("qty");

  function resetSelection(){
    hiddenId.value = "";
    meta.textContent = "Selecciona un producto para ver precio y stock.";
    btnAdd.disabled = true;
  }

  // ====== Sonido tipo caja (beep corto) ======
  function beepSuccess(){
    try {
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      const ctx = new AudioCtx();
      const o = ctx.createOscillator();
      const g = ctx.createGain();

      o.type = "sine";
      o.frequency.value = 880;      // tono
      g.gain.value = 0.06;          // volumen

      o.connect(g);
      g.connect(ctx.destination);

      o.start();
      setTimeout(() => {
        o.stop();
        ctx.close();
      }, 110);
    } catch(e) {
      // si el navegador bloquea audio, no pasa nada
    }
  }

  function findOptionByValue(value){
    const options = document.querySelectorAll("#productsList option");
    for (const opt of options){
      if (opt.value === value) return opt;
    }
    return null;
  }

  function refreshButtonState(stock){
    const q = parseInt(qty.value || "0", 10);
    if (!hiddenId.value) { btnAdd.disabled = true; return; }
    if (isNaN(q) || q <= 0) { btnAdd.disabled = true; return; }
    if (stock <= 0) { btnAdd.disabled = true; return; }
    if (q > stock) { btnAdd.disabled = true; return; }
    btnAdd.disabled = false;
  }

  // ====== Modo Caja: reset y focus ======
  function posReady(){
    search.value = "";
    qty.value = "1";
    resetSelection();
    search.focus();
  }

  // Focus al cargar
  window.addEventListener("load", () => {
    search.focus();

    // Si hay un flash success (venta registrada), hacemos beep + reset
    const flashSuccess = document.querySelector(".alert-success");
    if (flashSuccess){
      beepSuccess();
      posReady();
    }
  });

  // ====== Selección desde el datalist ======
  search.addEventListener("input", () => {
    const opt = findOptionByValue(search.value);
    if (!opt){
      resetSelection();
      return;
    }

    const id = opt.dataset.id;
    const price = opt.dataset.price;
    const stock = parseInt(opt.dataset.stock || "0", 10);

    hiddenId.value = id;
    meta.innerHTML = `Precio: <strong>$${price}</strong> · Stock: <strong>${stock}</strong>`;
    refreshButtonState(stock);
  });

  qty.addEventListener("input", () => {
    const opt = findOptionByValue(search.value);
    const stock = opt ? parseInt(opt.dataset.stock || "0", 10) : 0;
    refreshButtonState(stock);
  });

  // Enter en buscador -> pasa a cantidad (más rápido)
  search.addEventListener("keydown", (e) => {
    if (e.key === "Enter"){
      e.preventDefault();
      qty.focus();
      qty.select();
    }
  });

  // Enter en cantidad -> agrega (si está habilitado)
  qty.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !btnAdd.disabled){
      btnAdd.click();
    }
  });

  // Inicial
  resetSelection();
</script>

{% endblock %}
