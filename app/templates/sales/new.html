{% extends "base.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h3 class="mb-0">Nueva venta</h3>
    <div class="text-muted small">Busca y registra en segundos</div>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body">

    <form method="post" action="{{ url_for('sales.create_sale') }}" class="row g-2 align-items-end">

      <div class="col-12 col-md-6">
        <label class="form-label mb-1">Producto</label>

        <!-- Buscador -->
        <input id="productSearch"
               class="form-control"
               list="productsList"
               placeholder="Escribe para buscar..."
               autocomplete="off"
               required>

        <datalist id="productsList">
          {% for p in products %}
            <option value="{{ p.name }}"
                    data-id="{{ p.id }}"
                    data-price="{{ p.price }}"
                    data-stock="{{ p.stock }}"></option>
          {% endfor %}
        </datalist>

        <!-- aquí guardamos el id real -->
        <input type="hidden" name="product_id" id="productId">

        <div class="text-muted small mt-1" id="productMeta">
          Selecciona un producto para ver precio y stock.
        </div>
      </div>

      <div class="col-12 col-md-3">
        <label class="form-label mb-1">Cantidad</label>
        <input class="form-control" type="number" min="1" name="quantity" id="qty" value="1" required>
      </div>

      <div class="col-12 col-md-3 d-grid">
        <button class="btn btn-dark" id="btnSell">Registrar venta</button>
      </div>

    </form>
	
	{% if last_sale %}
		<div class="card mt-3 shadow-sm border-success">
		  <div class="card-body">
			<div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
			  <h6 class="mb-0">Última venta</h6>
			  <span class="badge bg-success">Registrada ✅</span>
			</div>

			<div class="mt-2 small text-muted">
			  Producto: <strong>{{ last_sale.product_name }}</strong><br>
			  Cantidad: <strong>{{ last_sale.quantity }}</strong><br>
			  Precio: <strong>${{ "%.2f"|format(last_sale.unit_price) }}</strong><br>
			  Total: <strong class="text-success">${{ "%.2f"|format(last_sale.total) }}</strong>
			</div>
		  </div>
		</div>
		{% endif %}

		<hr class="my-4">

		<h5 class="mb-2">Historial reciente</h5>
		<div class="card shadow-sm">
		  <div class="table-responsive">
			<table class="table mb-0 align-middle">
			  <thead class="table-light">
				<tr>
				  <th>Fecha</th>
				  <th>Producto</th>
				  <th class="text-end">Cant.</th>
				  <th class="text-end">Total</th>
				</tr>
			  </thead>
			  <tbody>
				{% for s in recent_sales %}
				<tr class="{% if last_sale and s.id == last_sale.id %}table-success{% endif %}">
				  <td class="text-muted small">{{ s.created_at }}</td>
				  <td>{{ s.product_name }}</td>
				  <td class="text-end">{{ s.quantity }}</td>
				  <td class="text-end text-success">${{ "%.2f"|format(s.total) }}</td>
				</tr>
				{% endfor %}
				{% if not recent_sales %}
				<tr>
				  <td colspan="4" class="text-center text-muted py-3">Aún no hay ventas</td>
				</tr>
    {% endif %}
      </tbody>
    </table>
  </div>
</div>


  </div>
</div>

<script>
  const search = document.getElementById("productSearch");
  const hiddenId = document.getElementById("productId");
  const meta = document.getElementById("productMeta");
  const btnSell = document.getElementById("btnSell");
  const qty = document.getElementById("qty");

  function resetSelection(){
    hiddenId.value = "";
    meta.textContent = "Selecciona un producto para ver precio y stock.";
    btnSell.disabled = true;
  }

  // inicialmente deshabilitamos hasta que elija un producto válido
  resetSelection();

  function findOptionByValue(value){
    const options = document.querySelectorAll("#productsList option");
    for (const opt of options){
      if (opt.value === value) return opt;
    }
    return null;
  }

  function refreshButtonState(stock){
    const q = parseInt(qty.value || "0", 10);
    if (!hiddenId.value) { btnSell.disabled = true; return; }
    if (isNaN(q) || q <= 0) { btnSell.disabled = true; return; }
    if (stock <= 0) { btnSell.disabled = true; return; }
    if (q > stock) { btnSell.disabled = true; return; }
    btnSell.disabled = false;
  }

  search.addEventListener("input", () => {
    const opt = findOptionByValue(search.value);
    if (!opt){
      resetSelection();
      return;
    }

    const id = opt.dataset.id;
    const price = opt.dataset.price;
    const stock = parseInt(opt.dataset.stock || "0", 10);

    hiddenId.value = id;

    meta.innerHTML = `Precio: <strong>$${price}</strong> · Stock: <strong>${stock}</strong>`;

    refreshButtonState(stock);
  });

  qty.addEventListener("input", () => {
    const opt = findOptionByValue(search.value);
    const stock = opt ? parseInt(opt.dataset.stock || "0", 10) : 0;
    refreshButtonState(stock);
  });
</script>

{% endblock %}
